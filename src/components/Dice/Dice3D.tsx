import React, { useEffect, useMemo } from 'react';
import { motion, useAnimation } from 'framer-motion';
import { useTranslation } from 'react-i18next';
import type { DiceFace, DiceType } from '../../types/game';
import clsx from 'clsx';

interface Dice3DProps {
    face: DiceFace;
    locked: boolean;
    onClick?: () => void;
    rolling: boolean;
    disabled?: boolean;
}

// --- CUSTOM SVGs FOR EXACT VISUAL MATCH ---

// --- CUSTOM SVGs FROM GAME-ICONS.NET (CC BY 3.0) ---

const IconAxe = ({ size, className }: { size: number, className?: string }) => (
    <svg width={size} height={size} viewBox="0 0 512 512" fill="currentColor" className={className}>
        <path d="M240.094 19.594c-56.69.364-110.882 29.054-151.594 72.344-53.428 56.81-81.948 137.907-61.03 210.093 16.33-8.797 32.757-15.987 48.936-21.374-6.327-123.16 89.247-210.922 200.03-210.344 4.255-13.365 10.268-27.308 18.127-41.874-16.323-5.43-32.736-8.36-48.97-8.782-1.833-.047-3.67-.074-5.5-.062zM271.28 88.97c-97.556 1.745-179.913 77.1-176.373 186.31 10.986-2.73 21.788-4.582 32.28-5.436 14.59-1.187 28.69-.463 41.783 2.437L278.312 162.94a114.81 114.81 0 0 1-9.344-38.75c-.716-11.256.14-22.983 2.592-35.22-.093.002-.187 0-.28 0zm60.845 60.718-16.875 16.875L345.75 197l16.813-16.813-30.438-30.5zm-37.125 23L175.625 292.063l44.625 44.562 119.313-119.313L295 172.688zm189.875 46.093c-14.466 7.808-28.318 13.807-41.594 18.064.75 111.013-87.243 206.8-210.686 200.28-5.39 16.104-12.552 32.462-21.313 48.72 72.19 20.922 153.313-7.6 210.126-61.03 57.045-53.65 88.516-130.72 63.47-206.033zm-136 15.657L240.687 342.625c3.23 13.563 4.086 28.245 2.844 43.47-.862 10.58-2.752 21.476-5.53 32.56 109.585 3.718 185.128-79.008 186.594-176.905-12.342 2.506-24.16 3.403-35.5 2.688-14.287-.9-27.698-4.347-40.22-10zM169.5 312.313 20.094 461.72V494H48.75l151.188-151.188-30.438-30.5z" />
    </svg>
);

const IconArrow = ({ size, className }: { size: number, className?: string }) => (
    <svg width={size} height={size} viewBox="0 0 512 512" fill="currentColor" className={className}>
        <path d="M331.734 20.443a4.421 4.421 0 0 0-1.802.327c-27.736 11.543-47.295 57.495-29.899 76.671 33.52 38.946 72.835 55.573 90.147 128.434 2.607 20.15 1.218 40.094 0 60.25-17.312 72.861-56.627 89.488-90.147 128.434-17.396 19.176 2.163 65.128 29.899 76.671 9.038 3.762 28.025-26.165 21.752-25.209-16.34 2.491-37.8-20.941-28.387-28.93 38.47-32.65 105.49-100.055 100.277-135.552-2.211-15.057-9.35-30.36-15.574-45.539 6.225-15.18 13.363-30.482 15.574-45.54 5.214-35.496-61.806-102.901-100.277-135.552-9.412-7.988 12.047-31.42 28.387-28.93 5.881.897-10.44-25.35-19.95-25.535zM152 24.23l-21.441 53.602L152 99.273l21.441-21.441zm-9 91.497v296.546l9-9 9 9V115.727l-2.637 2.636-6.363 6.364zm160 9.847v260.824l18-17.53V143.104zM152 428.727l-23 23v38.546l23-23 23 23v-38.546z" />
    </svg>
);

const IconShield = ({ size, className }: { size: number, className?: string }) => (
    <svg width={size} height={size} viewBox="0 0 512 512" fill="currentColor" className={className}>
        <path d="M261.563 64.28A191.758 191.758 0 0 0 64.25 256a191.758 191.758 0 1 0 383.5 0A191.758 191.758 0 0 0 261.562 64.28zm-4.625 9.126 8.937 5.156v10.313l-8.938 5.156-8.906-5.155V78.562l8.907-5.156zm3.53 29.25A153.407 153.407 0 0 1 409.407 256a153.407 153.407 0 0 1-306.812 0A153.407 153.407 0 0 1 260.47 102.656zm-11.53 20.03a133.607 133.607 0 0 0-65.157 20.908V368.22a133.607 133.607 0 0 0 65.157 21.092V122.688zm17.687.314v266.125a133.607 133.607 0 0 0 63.438-22.03V145a133.607 133.607 0 0 0-63.438-22zm-100.5 34.344A133.607 133.607 0 0 0 122.405 256a133.607 133.607 0 0 0 43.72 98.78V157.345zm-60.72 1.625 8.907 5.155v10.28l-8.906 5.157-8.937-5.156v-10.28l8.936-5.157zm300.5 0 8.94 5.155v10.28l-8.94 5.157-8.905-5.156v-10.28l8.906-5.157zm-58.155.093V353.03A133.607 133.607 0 0 0 389.594 256a133.607 133.607 0 0 0-41.844-96.938zm57.813 173.125 8.937 5.156v10.312l-8.938 5.156-8.906-5.156v-10.312l8.906-5.156zm-299.813.718 8.938 5.156v10.313l-8.938 5.156-8.938-5.155v-10.313l8.938-5.156zm149.906 85.188 8.938 5.156v10.313l-8.938 5.156-8.906-5.158v-10.31l8.906-5.156z" />
    </svg>
);

const IconHelmet = ({ size, className }: { size: number, className?: string }) => (
    <svg width={size} height={size} viewBox="0 0 512 512" fill="currentColor" className={className}>
        <path d="M52.441 53.88c-35.103 34.696-41.31 73.89-33.228 117.837 6.29 34.202 22.079 70.807 40.892 107.767 17.738-27.114 41.117-56.824 68.676-78.517-20.7-17.164-38.261-35.891-51.367-56.447-17.29-27.12-26.504-57.61-24.973-90.64zm407.118 0c1.531 33.03-7.683 63.52-24.973 90.64-13.106 20.556-30.667 39.283-51.367 56.447 27.559 21.693 50.938 51.403 68.676 78.517 18.813-36.96 34.603-73.565 40.892-107.767 8.082-43.947 1.875-83.141-33.228-117.836zM256 179c-8.702 0-17.061 2.757-23 7.316v22.38c6.7-2.648 14.535-4.016 23-4.016s16.3 1.368 23 4.015v-22.379c-5.939-4.559-14.298-7.316-23-7.316zm-41 30.053c-30.485 11.577-60.043 34.66-84.166 62.804C98.718 309.326 76.784 355.501 73.482 391H215V209.053zm82 0V391h141.518c-3.301-35.499-25.236-81.674-57.352-119.143-24.123-28.143-53.681-51.227-84.166-62.804zm-153.502 3.49c-29.097 22.175-55.189 56.212-73.732 85.506a2034.036 2034.036 0 0 0 9.447 17.562c10.162-19.226 23.088-38.126 37.953-55.468 11.983-13.98 25.289-26.965 39.557-38.155a416.25 416.25 0 0 1-13.225-9.445zm225.004 0a416.25 416.25 0 0 1-13.225 9.445c14.268 11.19 27.574 24.175 39.557 38.155 14.865 17.342 27.79 36.242 37.953 55.468 3.179-5.85 6.339-11.705 9.447-17.562-18.543-29.294-44.635-63.33-73.732-85.506zM256 222.68c-7.62 0-14.449 1.66-18.602 3.736-3.262 1.631-4.103 2.973-4.318 3.264.215.29 1.056 1.632 4.318 3.263 4.153 2.077 10.981 3.737 18.602 3.737 7.62 0 14.449-1.66 18.602-3.737 3.262-1.63 4.103-2.972 4.318-3.263-.215-.291-1.056-1.633-4.318-3.264-4.153-2.077-10.981-3.736-18.602-3.736zm22.92 7c.059.08.08.095.08 0 0-.096-.021-.08-.08 0zm-45.84 0c-.059-.08-.08-.096-.08 0 0 .095.021.08.08 0zm-.08 20.984v48.352c6.7-2.648 14.535-4.016 23-4.016s16.3 1.368 23 4.016v-48.352c-6.7 2.648-14.535 4.016-23 4.016s-16.3-1.368-23-4.016zM256 313c-7.62 0-14.449 1.66-18.602 3.736-3.262 1.632-4.103 2.973-4.318 3.264.215.291 1.056 1.632 4.318 3.264C241.551 325.34 248.38 327 256 327c7.62 0 14.449-1.66 18.602-3.736 3.262-1.632 4.103-2.973 4.318-3.264-.215-.291-1.056-1.632-4.318-3.264C270.449 314.66 263.62 313 256 313zm22.92 7c.059.08.08.096.08 0s-.021-.08-.08 0zm-45.84 0c-.059-.08-.08-.096-.08 0s.021.08.08 0zm-.08 20.984v45.87c6.7-2.649 14.535-4.016 23-4.016s16.3 1.367 23 4.016v-45.87c-6.7 2.648-14.535 4.016-23 4.016s-16.3-1.368-23-4.016zm23 59.854c-7.62 0-14.449 1.66-18.602 3.736-3.262 1.631-4.103 2.973-4.318 3.264.215.29 1.056 1.632 4.318 3.264 4.153 2.076 10.981 3.736 18.602 3.736 7.62 0 14.449-1.66 18.602-3.736 3.262-1.632 4.103-2.973 4.318-3.264-.215-.291-1.056-1.633-4.318-3.264-4.153-2.076-10.981-3.736-18.602-3.736zm22.92 7c.059.08.08.095.08 0 0-.096-.021-.08-.08 0zm-45.84 0c-.059-.08-.08-.096-.08 0 0 .095.021.08.08 0zM73 409v30h18.455c-2.78-4.422-4.455-9.52-4.455-15s1.676-10.578 4.455-15H73zm55 0c-7.013 0-13.194 2.204-17.227 5.229C106.74 417.253 105 420.615 105 424c0 3.385 1.74 6.747 5.773 9.771C114.806 436.796 120.987 439 128 439s13.194-2.204 17.227-5.229C149.26 430.747 151 427.385 151 424c0-3.385-1.74-6.747-5.773-9.771C141.194 411.204 135.013 409 128 409zm36.545 0c2.78 4.422 4.455 9.52 4.455 15s-1.676 10.578-4.455 15H215v-30h-50.455zM297 409v30h50.455c-2.78-4.422-4.455-9.52-4.455-15s1.676-10.578 4.455-15H297zm87 0c-7.013 0-13.194 2.204-17.227 5.229C362.74 417.253 361 420.615 361 424c0 3.385 1.74 6.747 5.773 9.771C370.806 436.796 376.987 439 384 439s13.194-2.204 17.227-5.229C405.26 430.747 407 427.385 407 424c0-3.385-1.74-6.747-5.773-9.771C397.194 411.204 391.013 409 384 409zm36.545 0c2.78 4.422 4.455 9.52 4.455 15s-1.676 10.578-4.455 15H439v-30h-18.455zM233 428.822v16.453l23 34.5 23-34.5v-16.453c-6.7 2.648-14.535 4.016-23 4.016s-16.3-1.368-23-4.016z" />
    </svg>
);

const IconHand = ({ size, className }: { size: number, className?: string }) => (
    <svg width={size} height={size} viewBox="0 0 512 512" fill="currentColor" className={className}>
        <path d="M296.472 22.826c-21.29.147-43.872 3.363-56.926 12.576L168.93 73.304l-39.355 53.457c-8.281 12.78-2.372 37.51 23.49 21.659l28.312-37.344c35.972-31.06 109.391-16.746 74.575 45.506-17.101 36.058-9.058 53.676 12.917 61.06l10.06-33.728c17.399-39.156 49.806-46.182 48.47-77.735 0 0 177.104 129.212 66.836 282.278-58.331 79.654-206.993 83.446-274.873 45.9C47.345 394.525 4.758 300.521 45.81 219.667c12.662-30.787 14.92-39.57-9.818-.42-45.683 81.518 16.354 220.248 86.937 250.776 99.658 43.104 265.63 8.011 311.414-51.113 21.881-28.258 47.416-72.584 54.906-123.082 7.635-51.472-3.544-97.003-24.162-140.225C428.352 78.594 348.128 29.886 348.128 29.886c-5.057-3.452-27.527-7.227-51.656-7.06zm-69.674 88.314c-12.66-.197-25.06 5.02-34.101 12.64l-28.387 37.331c7.763 6.19 15.544 2.885 23.348-4.617 9.183 4.637 16.248-2.57 22.084-16.946 2.404-9.814 5.97-16.759 17.056-28.408zm-96.586 61.522c-1.627-.013-3.2.353-4.728 1.095-3.06 1.538-6.497 5.054-9.617 11.633 14.028 9.52 29.958 20.009 42.595 35.022.94-.54 1.935-1.001 2.918-1.397.103-.022.203-.041.264-.084-2.515-16.675-10.719-32.75-19.736-40.658-4.265-3.722-8.115-5.583-11.696-5.611zm56.479 7.55c-4.934 8.328-10.222 16.926-13.367 26.669a58.653 58.653 0 0 0-2.245 9.994c.25-.02.504-.065.748-.02 3.085 0 6.247.702 9.184 2.203.312-3.102 1.038-6.077 1.936-9.056 2.664-8.2 7.47-16.237 12.488-24.588zm-88.662 7.327c-2.07-.031-4.276.531-6.692 1.623-.35.145-.682.313-.957.523-5.287 2.6-10.763 7.867-14.447 13.635-3.704 5.829-5.454 12.098-4.83 16.111.625 4.083 2.396 6.685 9.787 7.938 19.068 3.307 38.66 5.994 58.041 12.238 2.042-3.539 4.664-6.934 7.658-10.016 1.067-1.162 2.252-2.243 3.46-3.351-13.14-15.198-30.62-25.94-46.155-36.766-1.865-1.28-3.796-1.904-5.865-1.935zm122.14 18.197c-7.043-.06-13.582 1.395-19.59 4.018-5.913 2.682-11.24 6.533-16.07 11.466.354.317.723.587 1.08.922 1.998 1.749 3.789 3.993 5.328 6.64 8.933-9.873 19.548-14.033 33.21-12.68l.997-10.077a50.667 50.667 0 0 0-4.955-.289zm-48.385 21.256c-2.267.019-4.914.746-7.662 2.035-.373.21-.77.397-1.16.629-3.12 1.707-6.291 4.104-9.08 6.935-5.54 5.742-9.08 13.196-9.139 17.592 0 2.226.476 3.372 1.745 4.477.731.744 2.19 1.456 4.312 1.935 2.125-4.418 4.725-8.328 7.83-11.58 6.807-6.992 14.281-12.155 22.213-15.736.206-.125.48-.21.69-.336-.88-1.372-1.79-2.452-2.711-3.244-2.203-1.981-4.413-2.688-7.037-2.707zm40.344 9.674c-9.429.002-18.49 1.764-27.02 5.666-6.788 3.126-13.221 7.664-19.13 13.806-6.286 6.45-10.956 19.3-12.64 34.897-1.646 15.651-.557 33.887 3.333 51.107 3.87 17.155 12.802 31.705 19.239 44.512 48.312 96.12 209.412 11.679 146.525-76.113-10.5-14.66-22.464-33.69-40.617-47.389-18.216-13.574-39.686-23.569-60.145-25.916a82.067 82.067 0 0 0-9.545-.57zm-132.818.715c-.168 1.06-.336 2.12-.377 3.142-.522 6.412 1.06 11.64 3.539 14.531 2.454 2.831 5.577 4.162 11.68 2.461 12.969-3.542 29.08-5.895 40.826-7.332a9.24 9.24 0 0 0 .207-1.129c-18.07-5.741-36.83-8.362-55.875-11.673z" />
    </svg>
);

const ICONS: Record<DiceType, React.ReactNode> = {
    axe: <IconAxe size={48} className="text-[#3e2723] rotate-[15deg]" />,
    arrow: <IconArrow size={46} className="text-[#b71c1c] rotate-[15deg]" />,
    helmet: <IconHelmet size={44} className="text-[#37474f]" />,
    shield: <IconShield size={44} className="text-[#01579b]" />,
    hand: <IconHand size={42} className="text-[#e65100]" />,
};

// Standard Orlog Dice Neighbors (Visual approximation)
const NEIGHBORS: Record<DiceType, DiceType[]> = {
    axe: ['helmet', 'shield', 'arrow', 'hand', 'axe'],
    arrow: ['shield', 'helmet', 'axe', 'hand', 'arrow'],
    helmet: ['axe', 'arrow', 'shield', 'hand', 'helmet'],
    shield: ['arrow', 'axe', 'helmet', 'hand', 'shield'],
    hand: ['axe', 'helmet', 'arrow', 'shield', 'hand']
};

export const Dice3D: React.FC<Dice3DProps> = ({ face, locked, onClick, rolling, disabled }) => {
    const { t } = useTranslation();
    const controls = useAnimation();

    // Generate neighbors based on the current face type
    const decorativeFaces = useMemo(() => {
        const neighbors = NEIGHBORS[face.type];
        return [
            { type: neighbors[0], hasToken: false },
            { type: neighbors[1], hasToken: true },
            { type: neighbors[2], hasToken: false },
            { type: neighbors[3], hasToken: true },
            { type: neighbors[4], hasToken: false },
        ];
    }, [face.type]);

    useEffect(() => {
        if (rolling) {
            controls.start({
                rotateX: [0, 450, 810, 1440],
                rotateY: [0, 450, 810, 1440],
                rotateZ: [0, 180, 360],
                transition: { duration: 0.8, ease: "easeInOut" }
            });
        } else {
            controls.start({
                rotateX: 0,
                rotateY: 0,
                rotateZ: 0,
                transition: { type: "spring", stiffness: 120, damping: 20 }
            });
        }
    }, [rolling, controls]);

    const halfSize = "40px"; // 80px cube / 2

    const CubeFace = ({
        style,
        className,
        children,
        isFront = false,
        type,
        hasToken = false
    }: {
        style?: React.CSSProperties,
        className?: string,
        children?: React.ReactNode,
        isFront?: boolean,
        type: DiceType,
        hasToken?: boolean
    }) => (
        <div
            className={clsx(
                "absolute inset-0 rounded-sm flex items-center justify-center backface-hidden",
                // Material: Paper Texture
                "bg-[#d7ccc4] border border-[#8d6e63]",
                className
            )}
            style={style}
        >
            {/* Render Icon */}
            <div className={clsx("transform transition-all duration-300", locked && isFront ? "scale-90" : "scale-100")}>
                {ICONS[type]}
            </div>

            {/* Gold Token Border - Explicit Dashed Golden Square as in reference */}
            {hasToken && (
                <div className="absolute inset-[6px] border-[3px] border-dashed border-[#e6b800] opacity-90" />
            )}

            {/* Inner Shadow for recessed look */}
            <div className="absolute inset-0 shadow-[inset_0_0_15px_rgba(62,39,35,0.2)] pointer-events-none" />
        </div>
    );

    return (
        <div className="group relative w-24 h-24 flex items-center justify-center select-none perspective-[800px]">
            <motion.div
                className={clsx(
                    "w-20 h-20 relative preserve-3d cursor-pointer active:scale-95 transition-all duration-200",
                    locked ? "translate-y-3" : "hover:-translate-y-2",
                    disabled && !locked && "opacity-70 grayscale-[0.3]"
                )}
                style={{ transformStyle: 'preserve-3d' }}
                onClick={() => !disabled && onClick?.()}
                animate={controls}
            >
                {/* FRONT - Result Face */}
                <CubeFace
                    style={{ transform: `rotateY(0deg) translateZ(${halfSize})` }}
                    isFront={true}
                    type={face.type}
                    hasToken={face.hasToken}
                />

                {/* BACK */}
                <CubeFace
                    style={{ transform: `rotateY(180deg) translateZ(${halfSize})` }}
                    type={decorativeFaces[0].type}
                    hasToken={decorativeFaces[0].hasToken}
                />

                {/* RIGHT */}
                <CubeFace
                    style={{ transform: `rotateY(90deg) translateZ(${halfSize})` }}
                    type={decorativeFaces[1].type}
                    hasToken={decorativeFaces[1].hasToken}
                />

                {/* LEFT */}
                <CubeFace
                    style={{ transform: `rotateY(-90deg) translateZ(${halfSize})` }}
                    type={decorativeFaces[2].type}
                    hasToken={decorativeFaces[2].hasToken}
                />

                {/* TOP */}
                <CubeFace
                    style={{ transform: `rotateX(90deg) translateZ(${halfSize})` }}
                    type={decorativeFaces[3].type}
                    hasToken={decorativeFaces[3].hasToken}
                />

                {/* BOTTOM */}
                <CubeFace
                    style={{ transform: `rotateX(-90deg) translateZ(${halfSize})` }}
                    type={decorativeFaces[4].type}
                    hasToken={decorativeFaces[4].hasToken}
                />

                {locked && (
                    <motion.div
                        initial={{ opacity: 0, y: -10 }}
                        animate={{ opacity: 1, y: 0 }}
                        className="absolute -top-10 left-1/2 -translate-x-1/2 flex justify-center perspective-[100px] z-50 pointer-events-none"
                    >
                        <div className="px-2 py-0.5 bg-black/80 text-[10px] font-serif text-amber-500 border border-amber-900/50 rounded shadow-lg uppercase tracking-widest backdrop-blur-sm whitespace-nowrap">
                            {t('game.kept')}
                        </div>
                    </motion.div>
                )}

            </motion.div>

            {/* Shadow */}
            {!locked && !rolling && (
                <div className="absolute top-20 w-16 h-4 bg-black/30 blur-md rounded-[50%] transition-opacity duration-300 group-hover:scale-110 group-hover:bg-black/20" />
            )}
        </div>
    );
};
